version: "3.8"

networks:
  default:
    name: traefik

x-frappe-service: &frappe-service
  image: ${FRAPPE_IMAGE:-ghcr.io/frappe/erpnext:${ERPNEXT_VERSION:-version-15}}
  pull_policy: always
  restart: unless-stopped
  user: "frappe"
  depends_on:
    mariadb:
      condition: service_healthy
    redis-queue:
      condition: service_started
    redis-cache:
      condition: service_started
    redis-socketio:
      condition: service_started
  environment:
    FRAPPE_SITE: ${FRAPPE_SITE:-site1.local}
    SITE_DB_NAME: ${SITE_DB_NAME:-site1_local}
    DB_HOST: mariadb
    DB_PORT: 3306
    REDIS_QUEUE: redis-queue:6379
    REDIS_CACHE: redis-cache:6379
    REDIS_SOCKETIO: redis-socketio:6379
    SOCKETIO_PORT: 9000
    ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
    MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD:?required}
    MARIADB_USER: frappe
    MARIADB_PASSWORD: ${MARIADB_PASSWORD:-frappe}
  working_dir: /home/frappe/frappe-bench
  volumes:
    - frappe-sites:/home/frappe/frappe-bench/sites
    - frappe-logs:/home/frappe/frappe-bench/logs
    - type: bind
      source: .
      target: /workspace/repo
      read_only: true

services:
  backend:
    <<: *frappe-service
    container_name: frappe-backend
    command: ["/bin/bash", "/workspace/repo/deploy/ensure_site.sh", "gunicorn", "-b", "0.0.0.0:8000", "-w", "4", "-t", "120", "frappe.app:application"]
    expose:
      - "8000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"

  # ... (scheduler, workers, socketio same as before, just add labels if needed)

  mariadb:
    image: mariadb:10.6
    container_name: frappe-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${SITE_DB_NAME:-site1_local}
      MYSQL_USER: frappe
      MYSQL_PASSWORD: ${MARIADB_PASSWORD:-frappe}
    command: [--character-set-server=utf8mb4, --collation-server=utf8mb4_unicode_ci]
    volumes:
      - mariadb-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  frontend:
    image: nginx:alpine
    container_name: frappe-frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_started
      socketio:
        condition: service_started
    volumes:
      - ./deploy/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${SITE_HOST_NAME}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"

  # redis services unchanged

volumes:
  frappe-sites:
  frappe-logs:
  mariadb-data:
  redis-queue-data:
  redis-cache-data:
  redis-socketio-data: